import pandas as pd


info_df = pd.read_csv("../../data/DMS/dms.csv")
mutation_codes = info_df["scfv_mutations"].tolist()

input_file = "data/cr9114_newcal1999_processed_relaxed.pdb"

out_folder = "output"


rule final_output:
    input:
        out_folder + "/generation_summary.csv"

# use not relaxed wildtye for mutation
rule score_wildtype:
    input:
        input_file
    output:
        out_folder + "/wildtype.pdb",
    conda: "../../envs/rosetta_environment.yml"
    script: "scripts/score.py"

rule mutate_wildtype:
    input:
        input_file
    output:
        out_folder + "/mutated_wildtype/{mutation}.pdb"
    conda: "../../envs/rosetta_environment.yml"
    script: "scripts/mutate.py"

rule relax_mutated:
    input:
        out_folder +"/mutated_wildtype/{mutation}.pdb"
    output:
        out_folder + "/mutated_relaxed/{mutation}.pdb"
    conda: "../../envs/rosetta_environment.yml"
    resources:
        mem_mb=4000
    script: "scripts/relax.py"


rule calculate_change_in_binding_affinity:
    input:
        expand(out_folder + '/wildtype.pdb'),
        expand(out_folder + "/mutated_wildtype/{mutation}.pdb", mutation=mutation_codes),
        expand(out_folder + "/mutated_relaxed/{mutation}.pdb", mutation=mutation_codes),
    output:
        out_folder + "/generation_summary.csv"
    params:
        mutation_codes=mutation_codes,
        out_folder=out_folder
    conda: "../../envs/rosetta_environment.yml"
    script: "scripts/calculate_affinity_changes.py"
